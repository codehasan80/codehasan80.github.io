<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>önlisans özel güvenlik tercih robotu</title>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap');

    * {
      box-sizing: border-box;
    }

    body {
      background: #f4f7fa;
      font-family: 'Montserrat', sans-serif;
      margin: 0;
      padding: 40px 20px;
      color: #333;
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }

    .container {
      background: white;
      max-width: 480px;
      width: 100%;
      padding: 30px 35px;
      border-radius: 10px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }

    h1 {
      margin-top: 0;
      font-weight: 600;
      text-align: center;
      color: #2a2f4a;
    }

    label {
      display: block;
      margin: 18px 0 6px 0;
      font-weight: 600;
      font-size: 15px;
      color: #4a4a6a;
    }

    input[type="text"],
    select {
      width: 100%;
      padding: 12px 14px;
      border-radius: 6px;
      border: 1.8px solid #cbd3db;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    input[type="text"]:focus,
    select:focus {
      border-color: #4a90e2;
      outline: none;
    }

    button {
      margin-top: 28px;
      width: 100%;
      background-color: #4a90e2;
      color: white;
      border: none;
      padding: 15px 0;
      font-size: 18px;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #357ABD;
    }

    #retry-btn {
      margin-top: 15px;
      background-color: #e0e0e0;
      color: #555;
      border: 1.5px solid #ccc;
      font-weight: 600;
      display: none;
      cursor: pointer;
    }
    #retry-btn:hover {
      background-color: #ccc;
    }
   #onemli {
        color: red;
    }
    #result-area {
      margin-top: 30px;
      padding: 20px;
      background: #eef3fb;
      border-radius: 8px;
      font-size: 16px;
      color: #2a2f4a;
      line-height: 1.5;
      display: none;
    }

    
@media (max-width: 540px) {
  .container {
    width: 100vw;
    max-width: none;
    padding: 10px 10px;
    border-radius: 0; /* köşeleri de düzleştirebilirsin */
  }
  button {
    font-size: 16px;
    padding: 12px 0;
  }
}
  </style>
</head>
<body>
  <div class="container">
    <h1>önlisans gsb güvenlik tercih robotu</h1>
    <h5 id="onemli">
        sistem sadece bir defa veri girişi yapmanıza izin verir!! sadece bir defa veri girişi yapabilirsiniz bu yüzden puanınızı ve cinsiyetinizi doğru girdiğinize kesinlikle emin olun. ayrıca hangi şehri istiyorsanız o şehri seçin
    </h5  >
    <h5 id="onemli"><b>UYARI</b> kesinlikle puanınızı <br />
     cinsiyetinizi 
      <br />ve istediğiniz şehri doğru girdiğinizden emin olun</h5>

    <div id="form-area">
      <label for="username">Kullanıcı Adı</label>
      <input type="text" id="username" placeholder="Adınızı girin" required autocomplete="off" />

      <label for="gender">Cinsiyet</label>
      <select id="gender" required>
        <option value="">-- Seçiniz --</option>
        <option value="Kadın">Kadın</option>
        <option value="Erkek">Erkek</option>
      </select>

      <label for="education">Eğitim Durumu</label>
      <select id="education" required>
        <option value="">-- Seçiniz --</option>
        <option value="Lise">Lise</option>
        <option value="Önlisans">Önlisans</option>
        <option value="Lisans">Lisans</option>
      </select>

      <label for="score">Kpss Puanı (örnek: 79,34567) not: virgülden sonraki beş basamağıda girin sadece virgül kullanın</label>
      <input type="text" id="score" placeholder="79,34567" required autocomplete="off" />

      <label for="city">Şehir Seçin</label>
      <select id="city" required>
        <option value="">-- Şehir Seçin --</option>
      </select>
<div style="margin-top: 20px;">
  <input type="checkbox" id="kvkk-checkbox" required />
  <label for="kvkk-checkbox" style="font-size: 14px;">
    <a href="#" onclick="alert(kvkkText); return false;">KVKK ve Açık Rıza Metni'ni</a> okudum, anladım ve kabul ediyorum.
  </label>
</div>

      <!-- ✅ Burada onclick kaldırıldı -->
      <button id="save-btn">Kaydet ve Listele</button>
      
 

     
    </div>

    <button id="retry-btn">Başka arkadaşım için kayıt yapacağım</button>

    <div id="result-area"></div>
  </div>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
const supabaseUrl = 'https://meatgotukenyazmswpjb.supabase.co'
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1lYXRnb3R1a2VueWF6bXN3cGpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2NjgyMTcsImV4cCI6MjA3MDI0NDIxN30.Uy3U5-utN-QWvDuwW9ebqX7B7e1ylPU9Qr0T5CAIl1U'
const supabase = createClient(supabaseUrl, supabaseKey)
 window.kvkkText = `6698 sayılı Kişisel Verilerin Korunması Kanunu (KVKK) kapsamında, tarafınızca sağlanan kişisel veriler; yalnızca istatistiksel analiz ve sıralama amacıyla kullanılacak, üçüncü kişilerle paylaşılmayacaktır.

Tarafınıza ait veriler, yalnızca tarafınızın açık rızası ile alınmakta ve sadece bu sistem içerisinde kullanılmaktadır.

Bu verilerin kaydedilmesi, işlenmesi ve sıralama amaçlı analizlerde kullanılması hususunda bilgilendirildim ve açık rıza gösteriyorum.`;



  const cities = [
    "Adana","Adıyaman","Afyonkarahisar","Ağrı","Amasya","Ankara","Antalya","Artvin","Aydın","Balıkesir",
    "Bilecik","Bingöl","Bitlis","Bolu","Burdur","Bursa","Çanakkale","Çankırı","Çorum","Denizli","Diyarbakır",
    "Edirne","Elazığ","Erzincan","Erzurum","Eskişehir","Gaziantep","Giresun","Gümüşhane","Hakkari","Hatay",
    "Isparta","Mersin","İstanbul","İzmir","Kars","Kastamonu","Kayseri","Kırklareli","Kırşehir","Kocaeli",
    "Konya","Kütahya","Malatya","Manisa","Kahramanmaraş","Mardin","Muğla","Muş","Nevşehir","Niğde","Ordu",
    "Rize","Sakarya","Samsun","Siirt","Sinop","Sivas","Tekirdağ","Tokat","Trabzon","Tunceli","Şanlıurfa",
    "Uşak","Van","Yozgat","Zonguldak","Aksaray","Bayburt","Karaman","Kırıkkale","Batman","Şırnak","Bartın",
    "Ardahan","Iğdır","Yalova","Karabük","Kilis","Osmaniye","Düzce"
  ];

  const citySelect = document.getElementById("city");
  const retryButton = document.getElementById("retry-btn");
  const formArea = document.getElementById("form-area");
  const saveBtn = document.getElementById("save-btn");
  const resultArea = document.getElementById("result-area");

  function populateCities() {
    cities.forEach(city => {
      const option = document.createElement("option");
      option.value = city;
      option.textContent = city;
      citySelect.appendChild(option);
    });
  }
  populateCities();

  function parseScore(scoreStr) {
    return parseFloat(scoreStr.replace(',', '.'));
  }

  async function userExists(username, gender) {
    const { data, error } = await supabase
      .from('users')
      .select('*')
      .eq('username', username)
      .eq('gender', gender);

    if (error) {
      console.error("Kullanıcı kontrol hatası:", error);
      alert("Bir hata oluştu, lütfen sayfayı yenileyip tekrar deneyin.");
      throw error;
    }

    return data.length > 0;
  }

  async function saveData() {
    const username = document.getElementById("username").value.trim();
    const gender = document.getElementById("gender").value;
    const educationInput = document.getElementById("education").value;
    const scoreInput = document.getElementById("score").value.trim();
    const cityInput = document.getElementById("city").value;
    const isChecked = document.getElementById("kvkk-checkbox").checked;
    const regex = /^\d{1,2},\d{1,5}$/;

    if (!username) {
      alert("Lütfen adınızı girin.");
      return;
    }

    if (!gender) {
      alert("Lütfen cinsiyet seçin.");
      return;
    }

    if (!educationInput) {
      alert("Lütfen eğitim durumunuzu seçin.");
      return;
    }

    if (educationInput !== "Önlisans") {
      alert("Sadece Önlisans mezunları kayıt yapabilir.");
      return;
    }

    if (!regex.test(scoreInput)) {
      alert("Lütfen puanı doğru formatta girin: örnek 12,34567");
      return;
    }

    if (!cityInput) {
      alert("Lütfen bir şehir seçin.");
      return;
    }

    if (!isChecked) {
      alert("Lütfen KVKK ve Açık Rıza Metni'ni okuyup onaylayın.");
      return;
    }

    try {
      // Aynı kullanıcı adı ve cinsiyet var mı kontrol et
      const exists = await userExists(username, gender);
      if (exists) {
        alert("kullanıcı adı size özel olamalıdır örenğin emir yerine emir234 girerseniz daha iyi olur.");
        return;
      }

      // Kayıt ekle
      const { error: insertErr } = await supabase
        .from('users')
        .insert([{
          username: username,
          gender: gender,
          education: educationInput,
          city: cityInput,
          score: parseScore(scoreInput),
          isChecked: isChecked
        }]);

      if (insertErr) {
        console.error("Kayıt hatası:", insertErr);
        alert("Kayıt yapılırken bir hata oluştu."  + insertErr.message);
        return;
      }

      // Sonuçları göster
      await showLastResult(username, gender, cityInput);

      // Formu gizle, retry butonunu göster
      formArea.style.display = "none";
      retryButton.style.display = "block";

    } catch (error) {
      console.error("saveData hata:", error);
    }

   


  }

  async function calculateRank(users, username) {
    users.sort((a, b) => {
      if (b.score !== a.score) return b.score - a.score;
      return a.username.localeCompare(b.username);
    });

    for (let i = 0; i < users.length; i++) {
      if (users[i].username.toLowerCase() === username.toLowerCase()) {
        return i + 1;
      }
    }
    return -1;
  }

  async function showLastResult(username, gender, city) {
    try {
      // Tüm aynı cinsiyetteki kullanıcıları al
      let { data: users, error } = await supabase
        .from('users')
        .select('username, score, city')
        .eq('gender', gender);

      if (error) throw error;

      // Genel sıralama
      const genelRank = await calculateRank(users, username);

      // Şehir bazlı sıralama
      const cityUsers = users.filter(u => u.city === city);
      const cityRank = await calculateRank(cityUsers, username);

      resultArea.innerHTML = `
        <h2>Sonuçlar</h2>
        <p><strong>${username}</strong> isimli kullanıcı için:</p>
        <ul>
          <li><strong>Cinsiyetine göre genel sıralama:</strong>  ${users.length} kişi arasından ${genelRank} </li>
          <li><strong>${city} şehrindeki sıralama:</strong>   ${cityUsers.length} kişi arasından ${cityRank}</li>
        </ul>
      `;
      resultArea.style.display = "block";

    } catch (err) {
      console.error("Sonuç gösterme hatası:", err);
      alert("Sonuçlar gösterilirken bir hata oluştu.");
    }
  }

  retryButton.addEventListener("click", () => {
    formArea.style.display = "block";
    retryButton.style.display = "none";
    resultArea.style.display = "none";

    document.getElementById("username").value = "";
    document.getElementById("gender").value = "";
    document.getElementById("education").value = "";
    document.getElementById("score").value = "";
    document.getElementById("city").value = "";
  });

  saveBtn.addEventListener("click", saveData);
</script>




</body>

</html>
